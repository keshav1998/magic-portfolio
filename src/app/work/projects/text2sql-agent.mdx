---
title: "Text2SQL2Plot: LLM Agent for Industrial Data Analysis"
publishedAt: "2023-06-12"
summary: "LLM agent for field workers in turbomachinery plants using Vanna.ai and GPT-4o-mini, enabling natural language queries to SQL and automated visualization, reducing repair time by 20%."
images:
  - "/images/projects/text2sql/cover-01.jpg"
team:
  - name: "Keshav Mishra"
    role: "LLM Engineer"
    avatar: "/images/avatar.jpg"
    linkedIn: "https://www.linkedin.com/in/keshav98"
---

## Overview

Text2SQL2Plot is an intelligent LLM agent designed for field workers in turbomachinery plants, enabling them to query complex industrial databases using natural language and automatically generate insightful visualizations. Built with Vanna.ai and GPT-4o-mini, this system democratizes data access for non-technical personnel, leading to faster decision-making and a 20% reduction in equipment repair time.

## Problem Statement

Field workers and maintenance engineers in turbomachinery plants needed to access critical operational data to diagnose issues and plan repairs. However, they lacked SQL expertise and had to rely on data analysts to run queries and generate reports, causing significant delays. The typical workflow involved:

1. Field worker identifies an issue
2. Requests data from analyst (wait time: 2-4 hours)
3. Analyst writes SQL queries and generates charts
4. Field worker reviews data and may need additional queries
5. Process repeats, delaying repairs

This bottleneck increased equipment downtime and repair costs. The challenge was to empower field workers with direct data access without requiring SQL knowledge.

## Solution Architecture

### Core Components

**Natural Language Interface**: Built an intuitive conversational interface where users can ask questions in plain English about equipment performance, sensor readings, maintenance history, and operational metrics.

**Text-to-SQL Translation**: Leveraged Vanna.ai's framework combined with GPT-4o-mini to translate natural language queries into optimized SQL queries. The system understands domain-specific terminology and complex temporal queries.

**Automated Visualization**: Implemented intelligent chart selection and generation based on query results. The system automatically determines the most appropriate visualization type (line charts for time series, bar charts for comparisons, scatter plots for correlations, etc.).

**Context-Aware Query Refinement**: Maintains conversation history to enable follow-up questions and query refinement without repeating context.

## Key Features

- **Natural Language Queries**: "Show me turbine temperature trends for the last 7 days" â†’ SQL + Time series chart
- **Multi-Table Joins**: Handles complex queries spanning multiple database tables
- **Temporal Intelligence**: Understands relative time expressions ("last week", "this month", "compared to yesterday")
- **Aggregation & Analytics**: Automatically applies appropriate aggregations (avg, max, min, sum) based on query intent
- **Export Capabilities**: Generated charts and data can be exported for reports
- **Query History**: Saves frequently used queries for quick access
- **Error Handling**: Provides helpful suggestions when queries are ambiguous or data is unavailable
- **Mobile-Friendly**: Optimized for tablets and mobile devices used in the field

## Technologies Used

- **Vanna.ai**: Framework for training and deploying Text-to-SQL models
- **GPT-4o-mini**: Efficient LLM for natural language understanding and SQL generation
- **Python**: Backend implementation and data processing
- **Plotly**: Interactive data visualization library
- **PostgreSQL**: Primary database for operational data
- **FastAPI**: RESTful API for agent interactions
- **Redis**: Caching for frequently accessed queries and results
- **Docker**: Containerized deployment

## Implementation Details

### Training the Text-to-SQL Model

```python
from vanna.openai import OpenAI_Chat
from vanna.chromadb import ChromaDB_VectorStore

class MyVanna(ChromaDB_VectorStore, OpenAI_Chat):
    def __init__(self, config=None):
        ChromaDB_VectorStore.__init__(self, config=config)
        OpenAI_Chat.__init__(self, config=config)

vn = MyVanna(config={'model': 'gpt-4o-mini'})

# Train on database schema
vn.train(ddl="""
    CREATE TABLE turbine_sensors (
        timestamp TIMESTAMP,
        turbine_id VARCHAR(50),
        temperature FLOAT,
        pressure FLOAT,
        vibration FLOAT
    )
""")

# Train on example queries
vn.train(
    question="What was the average temperature yesterday?",
    sql="SELECT AVG(temperature) FROM turbine_sensors WHERE DATE(timestamp) = CURRENT_DATE - 1"
)
```

### Query Processing Pipeline

1. **Intent Classification**: Determine if query is asking for data, comparison, trend, or anomaly
2. **Entity Extraction**: Identify equipment IDs, time ranges, metrics, and thresholds
3. **SQL Generation**: Translate to optimized SQL with appropriate joins and filters
4. **Query Execution**: Run SQL against database with timeout and resource limits
5. **Visualization Selection**: Choose chart type based on data shape and query intent
6. **Chart Generation**: Create interactive visualizations with Plotly
7. **Response Formatting**: Present results with natural language summary

## Impact & Results

- **Repair Time Reduction**: 20% decrease in average equipment repair time
- **Query Response Time**: From 2-4 hours (via analyst) to under 30 seconds (self-service)
- **User Adoption**: 85% of field workers actively using the system daily
- **Query Volume**: Handling 500+ queries per day across multiple plants
- **Cost Savings**: Reduced analyst workload by 40%, allowing focus on complex analytics
- **Accuracy**: 92% of generated SQL queries are correct on first attempt
- **Downtime Reduction**: Faster data access contributed to 15% reduction in unplanned downtime

## Use Case Examples

### Example 1: Trend Analysis
**User Query**: "Show me turbine T-101 vibration levels for the past month"

**Generated SQL**:
```sql
SELECT timestamp, vibration 
FROM turbine_sensors 
WHERE turbine_id = 'T-101' 
  AND timestamp >= NOW() - INTERVAL '30 days'
ORDER BY timestamp
```

**Output**: Line chart with vibration trends and automatic anomaly highlighting

### Example 2: Comparative Analysis
**User Query**: "Compare average temperatures of all turbines this week"

**Generated SQL**:
```sql
SELECT turbine_id, AVG(temperature) as avg_temp
FROM turbine_sensors
WHERE timestamp >= DATE_TRUNC('week', NOW())
GROUP BY turbine_id
ORDER BY avg_temp DESC
```

**Output**: Bar chart comparing turbine temperatures with threshold indicators

### Example 3: Maintenance Correlation
**User Query**: "Show correlation between vibration and temperature for turbine T-205"

**Generated SQL**:
```sql
SELECT vibration, temperature
FROM turbine_sensors
WHERE turbine_id = 'T-205'
  AND timestamp >= NOW() - INTERVAL '7 days'
```

**Output**: Scatter plot with correlation coefficient and trend line

## Challenges and Learnings

**Domain Terminology**: Generic LLMs struggled with industry-specific terms like "bearing temperature", "shaft vibration", or equipment IDs. We addressed this by fine-tuning the model with domain-specific examples and maintaining a glossary of terms.

**Query Ambiguity**: Users often asked ambiguous questions like "show me the data". We implemented clarification prompts and default behaviors (e.g., defaulting to last 24 hours if no time range specified).

**Performance Optimization**: Initial queries on large datasets were slow. We implemented data partitioning, query result caching, and automatic aggregation for large time ranges.

**SQL Injection Prevention**: Implemented strict query validation and parameterization to prevent malicious queries while maintaining flexibility.

## Security & Reliability

- **Access Control**: Role-based access to different plant sections and data types
- **Query Validation**: All generated SQL is validated before execution
- **Resource Limits**: Query timeouts and row limits to prevent system overload
- **Audit Logging**: Complete log of all queries for compliance and debugging
- **Fallback Mechanisms**: Graceful degradation when LLM service is unavailable

## Future Enhancements

- **Predictive Queries**: "When will turbine T-101 likely need maintenance?"
- **Multi-Plant Comparisons**: Compare metrics across different facilities
- **Voice Interface**: Hands-free operation for field workers
- **Automated Alerts**: Proactive notifications based on query patterns
- **Report Generation**: Automated daily/weekly reports for management

## Outcome

Text2SQL2Plot has transformed how field workers interact with operational data in turbomachinery plants. By eliminating the analyst bottleneck and providing instant data access, the system has significantly reduced equipment repair times and improved operational efficiency. The success of this project has led to its expansion to other industrial facilities and has become a model for democratizing data access in technical environments.
